name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Replace API Key
      run: |
        # æª¢æŸ¥æ˜¯å¦æœ‰ API Key Secret
        if [ -z "${{ secrets.GOOGLE_MAPS_API_KEY }}" ]; then
          echo "âš ï¸ GOOGLE_MAPS_API_KEY secret æœªè¨­å®šï¼Œä½¿ç”¨é è¨­å€¼"
        else
          echo "âœ… æ‰¾åˆ° GOOGLE_MAPS_API_KEY secret"
          # æ›¿æ› env-loader.js ä¸­çš„ API Key
          sed -i "s/YOUR_LOCAL_DEV_API_KEY/${{ secrets.GOOGLE_MAPS_API_KEY }}/g" env-loader.js

          # é©—è­‰æ›¿æ›æ˜¯å¦æˆåŠŸ
          if grep -q "YOUR_LOCAL_DEV_API_KEY" env-loader.js; then
            echo "âŒ API Key æ›¿æ›å¤±æ•—"
          else
            echo "âœ… API Key æ›¿æ›æˆåŠŸ"
          fi
        fi

        # é¡¯ç¤ºæ–‡ä»¶å…§å®¹ä»¥ä¾›é™¤éŒ¯ï¼ˆä¸é¡¯ç¤ºå¯¦éš› API Keyï¼‰
        echo "ğŸ“„ env-loader.js å…§å®¹æª¢æŸ¥ï¼š"
        if grep -q "YOUR_LOCAL_DEV_API_KEY" env-loader.js; then
          echo "ä½¿ç”¨é è¨­ API Key"
        else
          echo "ä½¿ç”¨å¯¦éš› API Key"
        fi

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
